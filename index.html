<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejercicio</title>
    <style>
      :root{
        --bg:#f5f5f5;
        --white:#ffffff;
        --black:#1f1f1f;
        --accent:#4aa3ff;
        --shadow:0 8px 20px rgba(0,0,0,.08);

        --sel:#facc15;   /* amarillo selección */
        --ok:#22c55e;    /* verde */
        --bad:#ef4444;   /* rojo */
        --muted:#6b7280;
      }
      *{box-sizing:border-box}
      body{
        margin:0; min-height:100vh;
        display:grid; place-items:center;
        padding:22px 16px;
        background:var(--bg);
        font-family:Arial, sans-serif;
      }
      .card{
        width:min(920px,100%);
        background:rgba(255,255,255,.72);
        border-radius:22px;
        padding:16px 18px 18px;
        box-shadow:var(--shadow);
        backdrop-filter: blur(6px);
        position:relative;
        overflow:hidden;
      }

      /* Header */
      .topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-bottom:10px;
      }
      .title{
        font-size:20px;
        font-weight:900;
        letter-spacing:.2px;
        margin:0;
        color:#111827;
        user-select:none;
      }
      .score{
        display:flex;
        align-items:center;
        gap:10px;
        padding:8px 12px;
        border-radius:16px;
        background:#ffffff;
        box-shadow:var(--shadow);
        font-weight:900;
        color:#111827;
        user-select:none;
      }
      .score small{
        font-weight:800;
        color:var(--muted);
      }

      /* Choices */
      .choices{
        display:grid;
        grid-template-columns:repeat(4, minmax(70px,90px));
        gap:16px 20px;
        justify-content:center;
        margin-top:8px;
      }
      .note-group{
        display:grid;
        gap:10px;
        align-items:center;
        justify-items:center;
        padding:8px 6px;
        border-radius:16px;
      }
      button.note{
        border:3px solid transparent;
        cursor:pointer;
        width:82px; height:62px;
        border-radius:18px;
        box-shadow:var(--shadow);
        transition:transform .15s ease, box-shadow .15s ease, border-color .12s ease, filter .12s ease;
      }
      button.note:focus-visible{
        outline:3px solid var(--accent);
        outline-offset:4px;
      }
      .white{background:var(--white)}
      .black{background:var(--black)}
      .selected{
        border-color:var(--sel);
        box-shadow:0 10px 24px rgba(0,0,0,.12), 0 0 0 5px rgba(250,204,21,.25);
        transform:translateY(-2px);
      }

      /* Result borders after CHECK */
      .result-ok{
        border-color:var(--ok) !important;
        box-shadow:0 10px 24px rgba(0,0,0,.12), 0 0 0 5px rgba(34,197,94,.22) !important;
      }
      .result-bad{
        border-color:var(--bad) !important;
        box-shadow:0 10px 24px rgba(0,0,0,.12), 0 0 0 5px rgba(239,68,68,.22) !important;
      }

      /* Controls */
      .controls{
        display:flex;
        gap:12px;
        justify-content:center;
        align-items:center;
        margin-top:16px;
      }
      .btn{
        border:none;
        cursor:pointer;
        width:90px;
        height:70px;
        border-radius:22px;
        box-shadow:var(--shadow);
        font-size:30px;
        font-weight:900;
        transition:transform .1s ease, opacity .15s ease, filter .15s ease;
        display:grid;
        place-items:center;
        user-select:none;
      }
      .btn:active{transform:scale(.98)}
      .btn-primary{background:var(--accent); color:#fff;}
      .btn-check{background:#111827; color:#fff;}
      .btn-ghost{background:#fff; color:#111827;}

      .btn[disabled]{
        opacity:.28;
        cursor:not-allowed;
        filter:grayscale(.2);
      }

      /* Speaker overlay (solo aparece/desaparece) */
      .speaker{
        position:absolute;
        inset:0;
        display:grid;
        place-items:center;
        pointer-events:none;
        opacity:0;
        transition:opacity .15s ease;
      }
      .speaker.show{ opacity:1; }
      .speaker .bubble{
        width:120px;
        height:120px;
        border-radius:32px;
        background:rgba(255,255,255,.85);
        box-shadow:var(--shadow);
        display:grid;
        place-items:center;
        backdrop-filter: blur(6px);
      }
      .speaker svg{
        width:66px;
        height:66px;
      }
    </style>
  </head>

  <body>
    <div class="card" aria-label="Ejercicio">
      <div class="topbar">
        <h1 class="title" id="title">Melodía 1</h1>
        <div class="score" aria-label="Marcador">
          <small>✓</small>
          <span id="scoreText">0/0</span>
        </div>
      </div>

      <div class="choices" aria-label="Elegir blanco o negro">
        <div class="note-group" data-index="0">
          <button class="note white selected" aria-label="1 blanco"></button>
          <button class="note black" aria-label="1 negro"></button>
        </div>
        <div class="note-group" data-index="1">
          <button class="note white selected" aria-label="2 blanco"></button>
          <button class="note black" aria-label="2 negro"></button>
        </div>
        <div class="note-group" data-index="2">
          <button class="note white selected" aria-label="3 blanco"></button>
          <button class="note black" aria-label="3 negro"></button>
        </div>
        <div class="note-group" data-index="3">
          <button class="note white selected" aria-label="4 blanco"></button>
          <button class="note black" aria-label="4 negro"></button>
        </div>
      </div>

      <div class="controls" aria-label="Controles">
        <button class="btn btn-primary" id="listen" aria-label="Escuchar">▶</button>
        <button class="btn btn-check" id="check" aria-label="Comprobar">✓</button>
        <button class="btn btn-ghost" id="new" aria-label="Nuevo" disabled>↻</button>
      </div>

      <!-- Altavoz (solo aparece mientras suena) -->
      <div class="speaker" id="speaker" aria-hidden="true">
        <div class="bubble">
          <svg viewBox="0 0 64 64" fill="none">
            <path d="M28 22L18 30H10v4h8l10 8V22z" fill="#111827"/>
            <path d="M40 24c3 3 3 13 0 16" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round"/>
            <path d="M48 18c6 6 6 22 0 28" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" opacity=".75"/>
          </svg>
        </div>
      </div>
    </div>

    <script>
      // =============================
      // SOLO cambia la DURACIÓN:
      // Blanca = larga, Negra = corta
      // Mismo timbre y misma envolvente.
      // =============================

      const NOTE_COUNT = 4;

      // Duraciones claras
      const DUR_BLACK = 0.28;
      const DUR_WHITE = 0.62;
      const GAP = 0.06;

      // Volumen general (subido)
      // OJO: subir demasiado puede distorsionar en algunos altavoces.
      const MASTER_PEAK = 0.32; // antes 0.22 aprox

      // Marcador acumulado
      let totalCorrect = 0;
      let totalAttempts = 0;

      // Melodía actual (frecuencias) y patrón (white/black)
      let melodyIndex = 1;
      let currentFreqs = pickPrettyMelody();
      let answer = generateAnswer(); // array ["white"/"black"] de 4

      // Selección del alumno
      const selections = Array(NOTE_COUNT).fill("white");

      // Elements
      const groups = document.querySelectorAll(".note-group");
      const listenBtn = document.getElementById("listen");
      const checkBtn = document.getElementById("check");
      const newBtn = document.getElementById("new");
      const titleEl = document.getElementById("title");
      const scoreText = document.getElementById("scoreText");
      const speakerEl = document.getElementById("speaker");

      // Helper: actualizar score
      function updateScore() {
        scoreText.textContent = `${totalCorrect}/${totalAttempts}`;
      }
      updateScore();

      // UI selection
      groups.forEach((group) => {
        const index = Number(group.dataset.index);
        const buttons = group.querySelectorAll("button.note");

        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            // reset visual state of this group
            buttons.forEach((btn) => {
              btn.classList.remove("selected", "result-ok", "result-bad");
            });
            button.classList.add("selected");
            selections[index] = button.classList.contains("white") ? "white" : "black";
            // cuando cambian algo, deshabilitamos ↻ hasta acertar 4/4 otra vez
            newBtn.disabled = true;
          });
        });
      });

      // Audio context (reuse)
      let ctx = null;
      function getAudioContext() {
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === "suspended") ctx.resume();
        return ctx;
      }

      function playTone(freq, startTime, duration) {
        const context = getAudioContext();
        const osc = context.createOscillator();
        const gain = context.createGain();

        osc.type = "sine";
        osc.frequency.setValueAtTime(freq, startTime);

        const attack = 0.02;
        const release = 0.05;

        gain.gain.setValueAtTime(0.001, startTime);
        gain.gain.exponentialRampToValueAtTime(MASTER_PEAK, startTime + attack);
        gain.gain.exponentialRampToValueAtTime(
          0.001,
          startTime + Math.max(attack + 0.02, duration - release)
        );

        osc.connect(gain).connect(context.destination);
        osc.start(startTime);
        osc.stop(startTime + duration);
      }

      // Sin pistas: solo altavoz aparece/desaparece
      function showSpeaker() { speakerEl.classList.add("show"); }
      function hideSpeaker() { speakerEl.classList.remove("show"); }

      function generateAnswer() {
        let arr;
        do {
          arr = Array.from({ length: NOTE_COUNT }, () => (Math.random() < 0.5 ? "white" : "black"));
        } while (arr.every((x) => x === "white") || arr.every((x) => x === "black"));
        return arr;
      }

      // Melodías bonitas (pentatónicas / diatónicas sencillas)
      // Devuelve 4 frecuencias distintas por sesión.
      function pickPrettyMelody() {
        // Conjuntos agradables (en C mayor / pentatónica)
        const presets = [
          [261.63, 329.63, 392.00, 440.00], // C E G A
          [261.63, 293.66, 392.00, 440.00], // C D G A
          [293.66, 329.63, 392.00, 493.88], // D E G B
          [261.63, 392.00, 440.00, 523.25], // C G A C5
          [220.00, 261.63, 329.63, 392.00], // A3 C E G
          [392.00, 440.00, 493.88, 523.25], // G A B C5
        ];
        return presets[Math.floor(Math.random() * presets.length)];
      }

      function clearAllResultBorders() {
        groups.forEach((group) => {
          const buttons = group.querySelectorAll("button.note");
          buttons.forEach((btn) => btn.classList.remove("result-ok", "result-bad"));
        });
      }

      function playAnswerMelody() {
        clearAllResultBorders(); // quita verdes/rojos anteriores
        const context = getAudioContext();
        const start = context.currentTime + 0.03;

        showSpeaker();

        let t = start;
        for (let i = 0; i < NOTE_COUNT; i++) {
          const kind = answer[i];
          const dur = kind === "white" ? DUR_WHITE : DUR_BLACK;
          const freq = currentFreqs[i];

          playTone(freq, t, dur);
          t += dur + GAP;
        }

        // esconder altavoz cuando acaba
        const totalTime = (t - start);
        setTimeout(hideSpeaker, totalTime * 1000 + 60);
      }

      function checkAnswers() {
        clearAllResultBorders();

        let correct = 0;

        groups.forEach((group, i) => {
          const chosen = selections[i];
          const ok = chosen === answer[i];
          if (ok) correct++;

          // marcar SOLO el botón elegido (el que tiene "selected") en verde/rojo
          const chosenBtn = group.querySelector(chosen === "white" ? ".note.white" : ".note.black");
          chosenBtn.classList.remove("selected");
          chosenBtn.classList.add(ok ? "result-ok" : "result-bad");
        });

        totalCorrect += correct;
        totalAttempts += NOTE_COUNT;
        updateScore();

        // ↻ solo si 4/4
        newBtn.disabled = (correct !== NOTE_COUNT);
      }

      function newMelody() {
        if (newBtn.disabled) return;

        melodyIndex++;
        titleEl.textContent = `Melodía ${melodyIndex}`;

        currentFreqs = pickPrettyMelody();
        answer = generateAnswer();

        // reset visual to selections (amarillo) sin textos
        groups.forEach((group, i) => {
          const buttons = group.querySelectorAll("button.note");
          buttons.forEach((btn) => btn.classList.remove("result-ok", "result-bad", "selected"));
          const defaultBtn = group.querySelector(selections[i] === "white" ? ".note.white" : ".note.black");
          defaultBtn.classList.add("selected");
        });

        newBtn.disabled = true;
      }

      listenBtn.addEventListener("click", playAnswerMelody);
      checkBtn.addEventListener("click", checkAnswers);
      newBtn.addEventListener("click", newMelody);
    </script>
  </body>
</html>
